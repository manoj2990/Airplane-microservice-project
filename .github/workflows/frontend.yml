
name: Frontend - Build & Deploy

on:
    push:
        paths:
         - 'frontend/**'
        branches:
         - main

    workflow_dispatch:

env: #define all var/secrets here in one place as env
      NODE_VERSION: ${{ vars.NODE_VERSION }}
      DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
      DOCKER_HUB_ACCESS_TOKEN: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      DOCKER_IMAGE_NAME: ${{ vars.DOCKER_IMAGE_NAME }}
      VERCEL_DEPLOY_HOOK_FRONTEND: ${{ secrets.VERCEL_DEPLOY_HOOK_FRONTEND }}

jobs:
    build-frontend:
        name: build frontend
        runs-on: ubuntu-latest
        steps:
         - name: Checkout Repository
           uses: actions/checkout@v3
           

         - name: setup Node.js
           uses: actions/setup-node@v3
           with:
            node-version: ${{ env.NODE_VERSION }}
            cache: 'npm'
            cache-dependency-path: 'frontend/package-lock.json'
          

        
         - name: install dependencies
           run: |
           
            cd frontend
            npm ci

         - name: run eslint
           run: |
           
            cd frontend
            npm run lint --if-present
        
         - name: run test
           run: |
           
            cd frontend
            npm run test --if-present

         - name: Build Frontend app
           run: |
            
            cd frontend
            npm run build


    project-dockerization:
        name: Dockerize and Push to Docker Hub
        runs-on: ubuntu-latest
        needs: build-frontend
        
        steps:
            - name: checkout repository
              uses: actions/checkout@v4
            
            - name: login to docker hub
              uses: docker/login-action@v2
              with: 
                username: ${{ env.DOCKER_HUB_USERNAME }}
                password: ${{ env.DOCKER_HUB_ACCESS_TOKEN }}
            
            - name: build and push docker image
              uses: docker/build-push-action@v4
              with:
                context: ./frontend # . means root , ./frontend measn root se frontend folder main
                file: ./frontend/Dockerfile
                push: true
                tags: |
                 ${{ env.DOCKER_HUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest
                 ${{ env.DOCKER_HUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:v${{ github.run_number }}

    deploy-to-vercel:
        name: Deploy to vercel
        runs-on: ubuntu-latest
        needs: project-dockerization
        
        steps:
            - name: Trigger Vercel Deploy Hook
              run: |
               curl -X POST ${{ env.VERCEL_DEPLOY_HOOK_FRONTEND }}

        
        
        